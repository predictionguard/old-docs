---
title: Data Extraction
description: Data extract using PG with factuality checks
---
You can use PG to extract data from exterfile and perform factuality checks. This example uses transcripts of conversations between doctors and patients and extracts patient information. It further performs factuality checks. 

# Load the data 

Load the data from the [json file](pages/usingllms/transcript_data/transcripts.json). We will only be looking at the first 5 rows in the data for this exampel

```python copy
import json
import pandas as pd
import itertools
from langchain import PromptTemplate
import predictionguard as pg

data = []
with open('transcripts.json') as f:
    for line in itertools.islice(f, 5):
        line = line.strip()
        if not line: continue
        data.append(json.loads(line))

df = pd.DataFrame(data)

#transform rows to columns
df = df.transpose()

# Reset the index and assign an index column
df = df.reset_index()
df.columns = ['id', 'transcript']

# Reset the index (optional)
df.reset_index(drop=True, inplace=True)

#Just to test with starting 5 rows of the dataframe
df=df.head(5)
```

Use Nous hermes model to summaraize the patient doctor conversations and save the summarized transcript to scv

```python copy
summarize_template = """### Instruction:
Summarize the input transcript below.

### Input:
{transcript}

### Response:
"""

summary_prompt = PromptTemplate(template=summarize_template,
    input_variables=["context"],
)
summaries = []
for i,row in df.iterrows():
    result=pg.Completion.create(
        model="Nous-Hermes-Llama2-13B",
        prompt=summary_prompt.format(
            transcript=row['transcript']
        ),
        max_tokens=200,
        temperature=0.1
    )
    print(result['choices'][0]['text'])
    summaries.append(result['choices'][0]['text'])

df['summary']=summaries
print(df.head(5))
df.to_csv("summarized_transcripts.csv")
```

Load the data from the csv and add a prompt with the relevant questions for the data that we are interested to collect - symptoms, Patient name, when the symptom started, level of pain the patient is experiencing

```python copy
df=pd.read_csv("summarized_transcripts.csv")

questions=["What symptoms is the patient experiencing",
           "What is the Patient's name?",
           "When did the symptoms start?",
           "On a scale of 1 to 10, what level of pain is the patient experiencing?"]

question_answer_template = """### Instruction:
Answer the following question {question} using the below doctor-patient transcript summary.

### Input:
{transcript_summary}

### Response:
"""

q_and_a_prompt = PromptTemplate(template=question_answer_template,
    input_variables=["question", "transcript_summary"],
)
```
We will check the factuality of the data extracted with reference to the patient summary. 

```python copy
answers = {q: [] for q in questions}
fact_scores = {q: [] for q in questions}

for i, row in df.iterrows():
    for q in questions:
        result = pg.Completion.create(
            model="Nous-Hermes-Llama2-13B",
            prompt=q_and_a_prompt.format(
                question=q, transcript_summary=row["summary"]
            ),
            max_tokens=200,
            temperature=0.1,

        )
        fact_score = pg.Factuality.check(
            reference=row['summary'],
            text=result['choices'][0]['text']
        )
        fact_scores[q].append(fact_score['checks'][0]['score'])
        answers[q].append(result["choices"][0]["text"])

# Add the answers and fact scores as new columns to the original DataFrame
for q in questions:
    df[f"{q}_answer"] = answers[q]
    df[f"{q}_fact_score"] = fact_scores[q]

print(df.head(2))
df.to_csv("answers_with_fact_scores.csv", index=False)
```

We will save the newly created dataframe with the factuality scores into a csv. 


